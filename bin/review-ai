#!/bin/sh

# AI-powered git diff review script
# Usage: review-ai [-p markdown_file] [custom_prompt]
# Reviews current git changes including new files using Claude AI
# -p option allows specifying a markdown file for additional context

# Initialize variables
MARKDOWN_FILE=""
CUSTOM_PROMPT=""

# Parse options
while getopts "p:" opt; do
    case $opt in
        p)
            MARKDOWN_FILE="$OPTARG"
            # Check if markdown file exists
            if [ ! -f "$MARKDOWN_FILE" ]; then
                echo "Error: Markdown file '$MARKDOWN_FILE' not found" >&2
                exit 1
            fi
            ;;
        \?)
            echo "Usage: review-ai [-p markdown_file] [custom_prompt]" >&2
            echo "  -p: Specify a markdown file to include as review context" >&2
            exit 1
            ;;
    esac
done
shift $((OPTIND-1))

# Get custom prompt if provided
CUSTOM_PROMPT="$1"

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
   echo "Error: Not in a git repository" >&2
   exit 1
fi

# Check if claude command is available
if ! command -v claude > /dev/null 2>&1; then
   echo "Error: 'claude' command not found" >&2
   exit 1
fi

# Add all changes including new files to staging area
git add .

# Check if there are any changes to review
if ! git diff --cached --quiet HEAD; then
   # Build the prompt
   if [ -n "$MARKDOWN_FILE" ]; then
       # Read markdown content with error handling
       if ! MARKDOWN_CONTENT=$(cat "$MARKDOWN_FILE" 2>/dev/null); then
           echo "Error: Failed to read markdown file '$MARKDOWN_FILE'" >&2
           exit 1
       fi

       # Check markdown file size (warn if >50KB)
       if [ $(wc -c < "$MARKDOWN_FILE") -gt 50000 ]; then
           echo "Warning: Markdown file is large (>50KB). This may cause prompt length issues." >&2
       fi

       if [ -n "$CUSTOM_PROMPT" ]; then
           # Use custom prompt with markdown context
           PROMPT=$(cat << EOF
以下のMarkdownファイル（$MARKDOWN_FILE）の内容を確認し、git diffをレビューしてください。

【Markdownファイルの内容】
$MARKDOWN_CONTENT

【レビュー指示】
1. まず、上記Markdownファイル内で「ユーザーからの指示」に相当するセクション（例：「# ユーザーからの指示」「# 要件」「# 指示」など）を特定してください
2. Markdownファイル自体の内容について：
   - 特定したユーザー指示に対して、仕様書の内容が適切で十分であるか
   - 実装に必要な情報が不足していないか
   - 指示と仕様の整合性があるか
3. git diffの実装内容について、以下の観点でレビューしてください：
   - ユーザーの指示通りに実装されているか
   - 仕様書の内容と実装の整合性
   - 不要なソースコメントが記述されていないか（実装を読めばわかる内容のコメントは不要。例：変数宣言の説明、明らかなif文の条件説明など）
   - コードの品質と改善点
4. 追加レビュー指示: $CUSTOM_PROMPT
EOF
)
       else
           # Use default prompt with markdown context
           PROMPT=$(cat << EOF
以下のMarkdownファイル（$MARKDOWN_FILE）の内容を確認し、git diffから現在の編集内容をレビューしてください。

【Markdownファイルの内容】
$MARKDOWN_CONTENT

【レビュー手順】
1. まず、上記Markdownファイル内で「ユーザーからの指示」に相当するセクション（例：「# ユーザーからの指示」「# 要件」「# 指示」「# 概要」など）を特定してください

2. Markdownファイル自体の内容について評価してください：
   - 特定したユーザー指示に対して、仕様書の内容が適切で十分であるか
   - 実装に必要な情報が明確に記載されているか
   - 指示と仕様書の内容に矛盾や不整合がないか
   - 実装者が理解しやすい構成になっているか

3. git diffの実装内容について、以下の観点でレビューしてください：
   - ユーザーの指示・要件通りに実装されているか
   - Markdownファイル内の仕様書の内容と実装の整合性
   - 実装方針や設計との一貫性
   - 不要なソースコメントが記述されていないか（実装を読めばわかる内容のコメントは不要。例：変数宣言の説明、明らかなif文の条件説明など）
   - コードの品質、可読性、保守性
   - 潜在的な問題や改善点の指摘

4. 「ユーザーからの指示」に相当するセクションが見つからない場合は、Markdownファイル全体を仕様書として扱い、上記の観点でレビューを行ってください
EOF
)
       fi
   else
       # Use original behavior when no markdown file specified
       if [ -n "$CUSTOM_PROMPT" ]; then
           PROMPT="git diff から現在の編集内容を確認し、以下の観点を含めてレビューしてください：

- 不要なソースコメントが記述されていないか（実装を読めばわかる内容のコメントは不要）
- コードの品質、可読性、保守性
- 潜在的な問題や改善点

追加レビュー指示: $CUSTOM_PROMPT"
       else
           PROMPT="git diff から現在の編集内容を確認し、以下の観点を含めてレビューしてください：

- 不要なソースコメントが記述されていないか（実装を読めばわかる内容のコメントは不要。例：変数宣言の説明、明らかなif文の条件説明など）
- コードの品質、可読性、保守性
- 潜在的な問題や改善点の指摘"
       fi
   fi

   # Get the diff and pass it to claude
   git diff HEAD | claude -p "$PROMPT"
else
   echo "No changes to review." >&2
   exit 0
fi

